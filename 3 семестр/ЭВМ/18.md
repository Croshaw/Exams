[[ЭВМ|<==]]
![[17#Многопрограммный режим работы компьютеров]]
# Организация виртуальной памяти
Для организации виртуальной памяти адресное пространство, то есть максимально возможный объем оперативной памяти, который для 32-битовой адресной шины состоит из $2^{32}$ байтов, подразделяется на $2^{20}$ — 1 048 576 блоков памяти размером 4 Кбайт каждый. Такие блоки принято называть **логическими страницами**.
Фактически имеющаяся в компьютере оперативная память также делится на участки длиной 4 Кбайт, которые принято называть **страничными кадрами**.
В режиме виртуальной памяти часть логических страниц адресного пространства физически размещается в страничных кадрах оперативной памяти, а все не поместившиеся логические страницы записываются в специальный файл на магнитный диск. При этом программист считает все программы и данные находящимися в адресном пространстве процессора, то есть на логических страницах виртуальной памяти. Для него отсутствует разница между логическими страницами, фактически присутствующими в оперативной памяти, и станицами, находящимися на магнитном диске.
При любом обращении к памяти с помощью бита Р дескриптора сегмента определяется, находится ли связанная с сегментом логическая страница в оперативной памяти. Если страница находится в памяти, то происходит прямое обращение к ней. В противном случае нужная логическая страница автоматически загружается (**подкачивается**) операционной системой с жесткого диска в один из неиспользуемых или редко используемых страничных кадров оперативной памяти. Фиксированный размер всех страниц позволяет любую логическую страницу, фактически находящуюся на жестком диске, переписать в любой страничный кадр оперативной памяти. Для проверки использования страницы выполняющимися программами применяется бит А дескриптора сегмента, и для записи новой страницы выбираются только те кадры, в которых находятся сегменты со значением А = 0, то есть неиспользуемые сегменты. Старая логическая страница из выбранного страничного кадра переписывается на жесткий диск.
Поскольку на замену логических страниц требуется определенное время, выбор страничного кадра (из тех, у которых А — 0) для такой замены осуществляется по специальным алгоритмам, которые минимизируют необходимость ее выполнения.
Описанный процесс замещения логических страниц в страничных кадрах оперативной памяти называется **подкачкой**, или **свопингом** (от swap замена). Для осуществления свопинга операционная система автоматически формирует на жестком диске файл, название которого зависит от операционной системы. Например, в операционной системе Windows он называется swap.sys или pagefile.sys. Файл подкачки и физическая оперативная память вместе взятые образуют виртуальную память, поэтому файл подкачки называется также *файлом виртуальной памяти*.
Преобразование логических адресов в соответствующие им физические осуществляется аппаратным устройством **страничного преобразования адресов**. На его вход поступает линейный адрес, а на выходе формируется физический адрес и при необходимости замещается логическая страница в одном из страничных кадров. Адрес, сформированный устройством страничного преобразования, выставляется на адресную шину, откуда он считывается микросхемами памяти. В принципе, механизм виртуальной памяти может быть отключен, тогда физический адрес совпадает с линейным.
# Схема образования адреса в защищенном режиме
Для определения адреса глобального сегмента нужно сделать следующее.
1. Прочитать из регистра GDTR адрес глобальной дескрипторной таблицы GDT.
2. Выбрать селектор из заданного в команде сегментного регистра.
3. Выбрать из селектора индекс дескриптора.
4. Определить адрес дескриптора сегмента, умножив индекс на 8 и сложив результат с адресом GDT.
5. Выбрать из найденного таким образом дескриптора искомый адрес глобального сегмента памяти.

![[Pasted image 20240107012448.png|500]]
Рисунок 1 — Схема образования физического адреса в защищённом режиме

Для определения адреса локального сегмента вначале нужно описанным только что способом найти адрес сегмента, в котором находится таблица LDT, а затем уже в ней определить адрес локального сегмента.
1. Прочитать из регистра GDTR адрес глобальной дескрипторной таблицы GDT. 
2. Прочитать из регистра LDTR селектор дескриптора сегмента памяти, который содержит таблицу LDT.
3. Выбрать из селектора индекс дескриптора в глобальной таблице.
4. Определить адрес дескриптора, умножив индекс на 8 и сложив результат с адресом GDT. 
5. Выбрать из найденного дескриптора адрес сегмента памяти, в котором находится таблица LDT. 
6. Выбрать селектор из заданного в команде сегментного регистра. 
7. Выбрать из селектора индекс дескриптора искомого сегмента.
8. Определить адрес дескриптора, умножив его индекс на 8 и сложив результат с адресом таблицы LDT.
9. Выбрать из найденного дескриптора адрес искомого сегмента памяти.
После определения 32-битового адреса сегмента он складывается с 32-битовым эффективным адресом. Полученный таким образом адрес называется **линейным**. Если механизмы виртуальной памяти отключены, то линейный адрес является одновременно *физическим*, или *исполнительным*, адресом, который выставляется на адресную шину и по которому происходит фактическое обращение в оперативную память.